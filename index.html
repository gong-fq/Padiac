<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pediatric Cardiac SurgeryåŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .disclaimer {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .disclaimer strong {
            color: #856404;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 500;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* AIåŠ©æ‰‹æ ·å¼ */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 80%;
            line-height: 1.5;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: white;
            border: 1px solid #dee2e6;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åŒ»å­¦è¾å…¸æ ·å¼ */
        .dictionary-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
        }

        .lang-selector {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
        }

        .translation-result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            min-height: 200px;
            margin-top: 20px;
        }

        .term-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        /* éšè®¿æé†’æ ·å¼ */
        .reminder-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }

        .reminder-list {
            margin-top: 20px;
        }

        .reminder-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminder-item.overdue {
            border-left-color: #dc3545;
        }

        .reminder-item.upcoming {
            border-left-color: #ffc107;
        }

        /* å‚è€ƒèµ„æºæ ·å¼ */
        .resources {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .resources h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .resources ul {
            list-style: none;
        }

        .resources li {
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .resources a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s;
        }

        .resources a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å¿ƒè·³åŠ è½½åŠ¨ç”» */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            max-width: 80px;
        }

        .typing-indicator .heart {
            font-size: 24px;
            animation: heartbeat 1.2s ease-in-out infinite;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
            20%, 40% { transform: scale(1); }
        }

        @keyframes bounce {
            0%, 60%, 100% { 
                transform: translateY(0);
                opacity: 0.7;
            }
            30% { 
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* æ€è€ƒä¸­åŠ¨ç”» */
        .thinking-animation {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
        }

        .thinking-animation .bubble {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            animation: think 1.5s ease-in-out infinite;
        }

        .thinking-animation .bubble:nth-child(1) {
            animation-delay: 0s;
        }

        .thinking-animation .bubble:nth-child(2) {
            animation-delay: 0.3s;
        }

        .thinking-animation .bubble:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes think {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ«€ Pediatric Cardiac SurgeryåŠ©æ‰‹</h1>
            <p>å©´å¹¼å„¿å¿ƒå¤–ç§‘æ™ºèƒ½è¾…åŠ©ç³»ç»Ÿ</p>
            <p>å¤©æ´¥èƒ¸ç§‘åŒ»é™¢å¿ƒè¡€ç®¡å¤–ç§‘åŒ»å¸ˆåˆ˜èè®¾è®¡</p>
        </div>

        <div class="disclaimer">
            <strong>âš ï¸ å…è´£å£°æ˜ / Disclaimer:</strong><br>
            æœ¬ç³»ç»Ÿæä¾›çš„ä¿¡æ¯ä»…ä¾›ä¸´åºŠå©´å¹¼å„¿å¿ƒå¤–ç§‘åŒ»ç”Ÿå‚è€ƒï¼Œä¸èƒ½ä»£æ›¿ä¸“ä¸šåŒ»ç–—åˆ¤æ–­ã€‚æ‰€æœ‰ä¸´åºŠå†³ç­–å¿…é¡»ç»“åˆæ‚£å„¿çš„å…·ä½“æƒ…å†µã€æœ€æ–°åŒ»å­¦è¯æ®å’ŒåŒ»ç”Ÿçš„ä¸“ä¸šç»éªŒç»¼åˆåˆ¤æ–­ã€‚ä½¿ç”¨æœ¬ç³»ç»Ÿå³è¡¨ç¤ºæ‚¨åŒæ„æ­¤å…è´£å£°æ˜ã€‚
            <br><br>
            <em>The information provided by this system is for reference by clinical pediatric cardiac surgeons only and cannot replace professional medical judgment. All clinical decisions must be made based on the specific conditions of the patient, latest medical evidence, and professional experience of physicians.</em>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">ğŸ¤– AIåŠ©æ‰‹</button>
            <button class="tab" onclick="switchTab(1)">ğŸ“š åŒ»å­¦è¾å…¸</button>
            <button class="tab" onclick="switchTab(2)">â° éšè®¿æé†’</button>
            <button class="tab" onclick="switchTab(3)">ğŸ”— å‚è€ƒèµ„æº</button>
        </div>

        <!-- AIåŠ©æ‰‹ -->
        <div class="tab-content active">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-secondary" onclick="startVoiceInput()" id="voiceBtn">ğŸ¤ è¯­éŸ³</button>
                    <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">å‘é€</button>
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div style="color: #6c757d; font-size: 0.9em;">
                    ğŸ’¡ æç¤ºï¼šæ¯æ¡æ¶ˆæ¯éƒ½å¯ç‚¹å‡»ğŸ”ŠæŒ‰é’®æœ—è¯»ï¼Œæ”¯æŒä¸­è‹±å¾·ä¸‰è¯­è‡ªåŠ¨è¯†åˆ«
                </div>
                <button onclick="stopSpeaking()" class="btn btn-secondary" style="padding: 8px 16px;">
                    ğŸ”‡ åœæ­¢æœ—è¯»
                </button>
            </div>
        </div>

        <!-- åŒ»å­¦è¾å…¸ -->
        <div class="tab-content">
            <div class="dictionary-container">
                <h2 style="margin-bottom: 20px;">åŒ»å­¦æœ¯è¯­ç¿»è¯‘</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="dictInput" placeholder="è¾“å…¥åŒ»å­¦æœ¯è¯­...">
                    <select class="lang-selector" id="sourceLang">
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                    </select>
                    <button class="btn btn-primary" onclick="translateTerm()">ç¿»è¯‘</button>
                </div>
                <div class="translation-result" id="translationResult">
                    <p style="color: #6c757d;">åœ¨ä¸Šæ–¹è¾“å…¥æœ¯è¯­è¿›è¡Œç¿»è¯‘...</p>
                </div>
            </div>
        </div>

        <!-- éšè®¿æé†’ -->
        <div class="tab-content">
            <h2 style="margin-bottom: 20px;">æ‚£è€…éšè®¿ç®¡ç†</h2>
            <div class="reminder-form">
                <h3>æ·»åŠ éšè®¿æé†’</h3>
                <div class="form-group">
                    <label>æ‚£è€…å§“å/ID:</label>
                    <input type="text" id="patientName" placeholder="è¾“å…¥æ‚£è€…æ ‡è¯†">
                </div>
                <div class="form-group">
                    <label>æ‰‹æœ¯ç±»å‹:</label>
                    <input type="text" id="surgeryType" placeholder="ä¾‹å¦‚ï¼šVSDä¿®è¡¥æœ¯">
                </div>
                <div class="form-group">
                    <label>éšè®¿æ—¥æœŸ:</label>
                    <input type="date" id="followupDate">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨:</label>
                    <textarea id="notes" rows="3" placeholder="éšè®¿æ³¨æ„äº‹é¡¹..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addReminder()">æ·»åŠ æé†’</button>
            </div>
            <div class="reminder-list" id="reminderList"></div>
        </div>

        <!-- å‚è€ƒèµ„æº -->
        <div class="tab-content">
            <h2 style="margin-bottom: 20px;">ä¸»è¦å‚è€ƒåŒ»ç–—æœºæ„</h2>
            <div class="resources">
                <h3>ğŸŒ å›½é™…é¡¶å°–å„¿ç«¥å¿ƒè„ä¸­å¿ƒ</h3>
                <ul>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.dhzc.charite.de/en/" target="_blank">Deutsches Herzzentrum der CharitÃ© (DHZC)</a> - æŸæ—å¤é‡Œç‰¹å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.dhzb.de" target="_blank">Deutsches Herzzentrum Berlin (DHZB)</a> - å¾·å›½æŸæ—å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.heidelberg-university-hospital.com" target="_blank">Heidelberg University Hospital</a> - æµ·å¾·å ¡å¤§å­¦åŒ»é™¢</li>
                    <li>ğŸ‡©ğŸ‡ª <a href="https://www.lmu-klinikum.de" target="_blank">LMU Klinikum MÃ¼nchen</a> - æ…•å°¼é»‘å¤§å­¦åŒ»é™¢</li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.texaschildrens.org/heart" target="_blank">Texas Children's Heart Center</a> - å¾·å…‹è¨æ–¯å„¿ç«¥åŒ»é™¢å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.chop.edu/centers-programs/cardiac-center" target="_blank">Children's Hospital of Philadelphia - Cardiac Center</a> - è´¹åŸå„¿ç«¥åŒ»é™¢å¿ƒè„ä¸­å¿ƒ</li>
                    <li>ğŸ‡ºğŸ‡¸ <a href="https://www.childrenshospital.org/centers/heart-center" target="_blank">Boston Children's Hospital - Heart Center</a> - æ³¢å£«é¡¿å„¿ç«¥åŒ»é™¢å¿ƒè„ä¸­å¿ƒ</li>
                </ul>
                
                <h3 style="margin-top: 25px;">ğŸ‡¨ğŸ‡³ ä¸­å›½ä¸»è¦å„¿ç«¥å¿ƒè„ä¸­å¿ƒ</h3>
                <ul>
                    <li><a href="https://www.scmc.com.cn/list/1404/2617.html" target="_blank">ä¸Šæµ·äº¤é€šå¤§å­¦åŒ»å­¦é™¢é™„å±ä¸Šæµ·å„¿ç«¥åŒ»å­¦ä¸­å¿ƒ - å¿ƒèƒ¸å¤–ç§‘</a></li>
                    <li><a href="https://www.fuwaihospital.org/Departments/Main/Detail/60" target="_blank">ä¸­å›½åŒ»å­¦ç§‘å­¦é™¢é˜œå¤–åŒ»é™¢ - å°å„¿å¿ƒè„å¤–ç§‘ä¸­å¿ƒ</a></li>
                    <li><a href="https://www.301hospital.com.cn/hospital/sixth/xexzwk.html" target="_blank">ä¸­å›½äººæ°‘è§£æ”¾å†›æ€»åŒ»é™¢(301åŒ»é™¢) - å°å„¿å¿ƒè„å¤–ç§‘</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let chatHistory = [];
        let reminders = JSON.parse(localStorage.getItem('reminders')) || [];
        let recognition = null;
        let synthesis = window.speechSynthesis;

        // æ ‡ç­¾åˆ‡æ¢
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            contents.forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });

            if (index === 2) {
                displayReminders();
            }
        }

        // AIåŠ©æ‰‹åŠŸèƒ½
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';

            // æ·»åŠ æ€è€ƒåŠ¨ç”»
            const thinkingId = addThinkingAnimation();

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span>';

            // æ£€æµ‹ç”¨æˆ·æé—®çš„è¯­è¨€
            const userLang = detectLanguage(message);
            let systemPrompt = '';
            
            if (userLang === 'zh-CN') {
                systemPrompt = 'ä½ æ˜¯ä¸“ä¸šçš„å°å„¿å¿ƒè„å¤–ç§‘åŒ»ç–—åŠ©æ‰‹ã€‚è¯·ç”¨ä¸­æ–‡ç®€æ´ä¸“ä¸šåœ°å›ç­”ã€‚æé†’ï¼šå»ºè®®ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£åŒ»ç”Ÿåˆ¤æ–­ã€‚';
            } else if (userLang === 'de-DE') {
                systemPrompt = 'Sie sind ein professioneller Assistent fÃ¼r pÃ¤diatrische Herzchirurgie. Antworten Sie prÃ¤zise auf Deutsch. Hinweis: Nur Referenz, ersetzt keine medizinische Beurteilung.';
            } else {
                systemPrompt = 'You are a professional pediatric cardiac surgery assistant. Answer concisely in English. Note: For reference only, not a substitute for professional medical judgment.';
            }

            try {
                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: systemPrompt
                            },
                            ...chatHistory,
                            { role: 'user', content: message }
                        ],
                        temperature: 0.5,
                        max_tokens: 1000
                    })
                });

                // ç§»é™¤æ€è€ƒåŠ¨ç”»
                removeThinkingAnimation(thinkingId);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'APIè¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();
                const reply = data.choices[0].message.content;
                
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: reply });

                addMessage(reply, 'assistant', true);
            } catch (error) {
                removeThinkingAnimation(thinkingId);
                addMessage('æŠ±æ­‰ï¼Œè¿æ¥AIæœåŠ¡æ—¶å‡ºç°é”™è¯¯ï¼š' + error.message + 'ã€‚è¯·ç¨åé‡è¯•ã€‚', 'assistant');
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'å‘é€';
            }
        }

        function addThinkingAnimation() {
            const messagesDiv = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            const thinkingId = 'thinking-' + Date.now();
            thinkingDiv.id = thinkingId;
            thinkingDiv.className = 'message assistant';
            thinkingDiv.innerHTML = `
                <div class="thinking-animation">
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                </div>
            `;
            messagesDiv.appendChild(thinkingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return thinkingId;
        }

        function removeThinkingAnimation(thinkingId) {
            const thinkingDiv = document.getElementById(thinkingId);
            if (thinkingDiv) {
                thinkingDiv.remove();
            }
        }

        function addMessage(text, sender, enableTTS = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // ä¸ºæ‰€æœ‰æ¶ˆæ¯æ·»åŠ TTSåŠŸèƒ½
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            
            const ttsBtn = document.createElement('button');
            ttsBtn.innerHTML = 'ğŸ”Š';
            ttsBtn.style.cssText = 'margin-left: 10px; background: none; border: none; cursor: pointer; font-size: 1.2em; opacity: 0.7; transition: opacity 0.3s;';
            ttsBtn.title = 'ç‚¹å‡»æœ—è¯»';
            ttsBtn.onmouseover = () => ttsBtn.style.opacity = '1';
            ttsBtn.onmouseout = () => ttsBtn.style.opacity = '0.7';
            ttsBtn.onclick = () => {
                speakText(text);
                // è§†è§‰åé¦ˆ
                ttsBtn.innerHTML = 'ğŸ”‰';
                setTimeout(() => ttsBtn.innerHTML = 'ğŸ”Š', 300);
            };
            
            messageDiv.appendChild(textSpan);
            messageDiv.appendChild(ttsBtn);
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // è¯­éŸ³è¾“å…¥
        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;

            const voiceBtn = document.getElementById('voiceBtn');
            voiceBtn.innerHTML = 'ğŸ¤ å½•éŸ³ä¸­...';
            voiceBtn.disabled = true;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chatInput').value = transcript;
            };

            recognition.onerror = (event) => {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
            };

            recognition.onend = () => {
                voiceBtn.innerHTML = 'ğŸ¤ è¯­éŸ³';
                voiceBtn.disabled = false;
            };

            recognition.start();
        }

        // æ–‡å­—è½¬è¯­éŸ³ - æ™ºèƒ½è¯­è¨€æ£€æµ‹
        function speakText(text) {
            if (synthesis.speaking) {
                synthesis.cancel();
            }

            // æ¸…ç†æ–‡æœ¬ï¼šç§»é™¤emojisã€æ˜Ÿå·ã€ç ´æŠ˜å·ç­‰å¹²æ‰°ç¬¦å·
            const cleanedText = cleanTextForSpeech(text);
            
            if (!cleanedText.trim()) {
                console.log('æ¸…ç†åæ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡æœ—è¯»');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(cleanedText);
            
            // æ™ºèƒ½æ£€æµ‹è¯­è¨€
            const detectedLang = detectLanguage(cleanedText);
            utterance.lang = detectedLang;
            
            // æ ¹æ®è¯­è¨€è°ƒæ•´è¯­é€Ÿ
            if (detectedLang === 'de-DE') {
                utterance.rate = 0.85; // å¾·è¯­ç¨æ…¢
            } else if (detectedLang === 'en-US') {
                utterance.rate = 0.9;  // è‹±è¯­æ­£å¸¸
            } else {
                utterance.rate = 0.9;  // ä¸­æ–‡æ­£å¸¸
            }
            
            utterance.pitch = 1;
            utterance.volume = 1;
            
            synthesis.speak(utterance);
        }

        // æ¸…ç†æ–‡æœ¬ç”¨äºè¯­éŸ³æ’­æ”¾
        function cleanTextForSpeech(text) {
            return text
                // ç§»é™¤æ‰€æœ‰emojisï¼ˆåŒ…æ‹¬å„ç§Unicodeè¡¨æƒ…ç¬¦å·ï¼‰
                .replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F000}-\u{1F02F}]|[\u{1F0A0}-\u{1F0FF}]|[\u{1F100}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{1F910}-\u{1F96B}]|[\u{1F980}-\u{1F9E0}]/gu, '')
                // ç§»é™¤å¸¸è§è¡¨æƒ…ç¬¦å·
                .replace(/[ğŸ˜€-ğŸ™ğŸŒ€-ğŸ—¿ğŸš€-ğŸ›¿âœ‚-â°â“‚-ğŸ‰‘]/g, '')
                // ç§»é™¤æ˜Ÿå·
                .replace(/\*+/g, '')
                // ç§»é™¤ä¸­æ–‡ç ´æŠ˜å·
                .replace(/â€”â€”+/g, '')
                // ç§»é™¤è‹±æ–‡ç ´æŠ˜å·
                .replace(/--+/g, '')
                .replace(/â€”+/g, '')
                // ç§»é™¤ä¸‹åˆ’çº¿
                .replace(/_+/g, ' ')
                // ç§»é™¤å¤šä¸ªäº•å·æ ‡è®°
                .replace(/#+/g, '')
                // ç§»é™¤ç‰¹æ®Šæ ‡è®°ç¬¦å·
                .replace(/[â—â—‹â– â–¡â—†â—‡â˜…â˜†â–²â–³â–¼â–½]/g, '')
                // ç§»é™¤é¡¹ç›®ç¬¦å·
                .replace(/[â€¢Â·]/g, '')
                // æ¸…ç†å¤šä½™ç©ºæ ¼
                .replace(/\s+/g, ' ')
                .trim();
        }

        // è¯­è¨€æ£€æµ‹å‡½æ•°
        function detectLanguage(text) {
            // æ£€æµ‹ä¸­æ–‡å­—ç¬¦ï¼ˆåŒ…æ‹¬ç®€ä½“å’Œç¹ä½“ï¼‰
            const chineseRegex = /[\u4e00-\u9fa5]/;
            // æ£€æµ‹å¾·è¯­ç‰¹æ®Šå­—ç¬¦
            const germanRegex = /[Ã¤Ã¶Ã¼ÃŸÃ„Ã–Ãœ]/;
            // å¾·è¯­å¸¸ç”¨è¯
            const germanWords = /\b(und|der|die|das|ist|sind|haben|werden|mit|von|fÃ¼r|auf|bei|durch)\b/i;
            
            // è®¡ç®—å„ç§å­—ç¬¦çš„æ¯”ä¾‹
            const chineseCount = (text.match(chineseRegex) || []).length;
            const hasGermanChars = germanRegex.test(text);
            const hasGermanWords = germanWords.test(text);
            
            // åˆ¤æ–­é€»è¾‘
            if (chineseCount > text.length * 0.3) {
                return 'zh-CN'; // ä¸­æ–‡å æ¯”è¶…è¿‡30%
            } else if (hasGermanChars || hasGermanWords) {
                return 'de-DE'; // æœ‰å¾·è¯­ç‰¹å¾
            } else {
                return 'en-US'; // é»˜è®¤è‹±è¯­
            }
        }

        // ç¿»è¯‘ç»“æœæœ—è¯»ï¼ˆæŒ‡å®šè¯­è¨€ï¼‰
        function speakTranslation(lang) {
            const translationText = document.getElementById('translationText');
            if (!translationText) return;

            if (synthesis.speaking) {
                synthesis.cancel();
            }

            // æ¸…ç†æ–‡æœ¬
            const cleanedText = cleanTextForSpeech(translationText.textContent);
            
            if (!cleanedText.trim()) {
                console.log('æ¸…ç†åæ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡æœ—è¯»');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(cleanedText);
            utterance.lang = lang;
            
            // æ ¹æ®è¯­è¨€è°ƒæ•´è¯­é€Ÿ
            if (lang === 'de-DE') {
                utterance.rate = 0.85;
            } else if (lang === 'en-US') {
                utterance.rate = 0.9;
            } else {
                utterance.rate = 0.9;
            }
            
            utterance.pitch = 1;
            utterance.volume = 1;
            
            // æœ—è¯»å®Œæˆåçš„åé¦ˆ
            utterance.onend = () => {
                console.log('æœ—è¯»å®Œæˆ');
            };
            
            utterance.onerror = (event) => {
                console.error('æœ—è¯»å‡ºé”™:', event);
                alert('æœ—è¯»å¤±è´¥ï¼Œæ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒè¯¥è¯­è¨€çš„è¯­éŸ³åˆæˆ');
            };
            
            synthesis.speak(utterance);
        }

        // åœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾
        function stopSpeaking() {
            if (synthesis.speaking) {
                synthesis.cancel();
                console.log('å·²åœæ­¢æœ—è¯»');
            }
        }

        // åŒ»å­¦è¾å…¸åŠŸèƒ½
        async function translateTerm() {
            const input = document.getElementById('dictInput').value.trim();
            const sourceLang = document.getElementById('sourceLang').value;
            const resultDiv = document.getElementById('translationResult');

            if (!input) {
                resultDiv.innerHTML = '<p style="color: #dc3545;">è¯·è¾“å…¥è¦ç¿»è¯‘çš„æœ¯è¯­</p>';
                return;
            }

            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="typing-indicator" style="margin: 0 auto;">
                        <span class="heart">ğŸ’™</span>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <p style="margin-top: 15px; color: #667eea;">æ­£åœ¨ç¿»è¯‘ä¸­...</p>
                </div>
            `;

            try {
                const response = await fetch('/.netlify/functions/translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        term: input,
                        sourceLang: sourceLang
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ç¿»è¯‘å¤±è´¥');
                }

                const data = await response.json();
                const translation = data.choices[0].message.content;

                resultDiv.innerHTML = `
                    <div class="term-card">
                        <h3>ğŸ“– ç¿»è¯‘ç»“æœ</h3>
                        <div style="white-space: pre-wrap; line-height: 1.8;" id="translationText">${translation}</div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="speakTranslation('zh-CN')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š ä¸­æ–‡æœ—è¯»
                            </button>
                            <button onclick="speakTranslation('en-US')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š English
                            </button>
                            <button onclick="speakTranslation('de-DE')" class="btn btn-secondary" style="padding: 8px 16px;">
                                ğŸ”Š Deutsch
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = '<p class="error-message">ç¿»è¯‘å¤±è´¥ï¼š' + error.message + '</p>';
                console.error('Translation error:', error);
            }
        }

        // éšè®¿æé†’åŠŸèƒ½
        function addReminder() {
            const patientName = document.getElementById('patientName').value.trim();
            const surgeryType = document.getElementById('surgeryType').value.trim();
            const followupDate = document.getElementById('followupDate').value;
            const notes = document.getElementById('notes').value.trim();

            if (!patientName || !surgeryType || !followupDate) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            const reminder = {
                id: Date.now(),
                patientName,
                surgeryType,
                followupDate,
                notes,
                createdAt: new Date().toISOString()
            };

            reminders.push(reminder);
            localStorage.setItem('reminders', JSON.stringify(reminders));

            // æ¸…ç©ºè¡¨å•
            document.getElementById('patientName').value = '';
            document.getElementById('surgeryType').value = '';
            document.getElementById('followupDate').value = '';
            document.getElementById('notes').value = '';

            displayReminders();
            alert('éšè®¿æé†’å·²æ·»åŠ ');
        }

        function displayReminders() {
            const listDiv = document.getElementById('reminderList');
            const today = new Date().toISOString().split('T')[0];

            if (reminders.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">æš‚æ— éšè®¿æé†’</p>';
                return;
            }

            // æŒ‰æ—¥æœŸæ’åº
            reminders.sort((a, b) => new Date(a.followupDate) - new Date(b.followupDate));

            listDiv.innerHTML = reminders.map(reminder => {
                const followupDate = new Date(reminder.followupDate);
                const isPast = reminder.followupDate < today;
                const isUpcoming = !isPast && (new Date(reminder.followupDate) - new Date(today)) / (1000 * 60 * 60 * 24) <= 7;
                const statusClass = isPast ? 'overdue' : isUpcoming ? 'upcoming' : '';

                return `
                    <div class="reminder-item ${statusClass}">
                        <div>
                            <strong>${reminder.patientName}</strong> - ${reminder.surgeryType}<br>
                            <small>ğŸ“… éšè®¿æ—¥æœŸ: ${reminder.followupDate}</small><br>
                            ${reminder.notes ? `<small>ğŸ“ ${reminder.notes}</small>` : ''}
                        </div>
                        <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="deleteReminder(${reminder.id})">åˆ é™¤</button>
                    </div>
                `;
            }).join('');
        }

        function deleteReminder(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤æé†’å—ï¼Ÿ')) {
                reminders = reminders.filter(r => r.id !== id);
                localStorage.setItem('reminders', JSON.stringify(reminders));
                displayReminders();
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addMessage('æ‚¨å¥½ï¼æˆ‘æ˜¯å°å„¿å¿ƒè„å¤–ç§‘æ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”ä¸“ä¸šé—®é¢˜ã€æä¾›å‚è€ƒä¿¡æ¯ã€‚è¯·æ³¨æ„ï¼Œæ‰€æœ‰å»ºè®®ä»…ä¾›å‚è€ƒï¼Œå®é™…è¯Šç–—éœ€ç»“åˆæ‚£å„¿å…·ä½“æƒ…å†µç”±åŒ»ç”Ÿåˆ¤æ–­ã€‚', 'assistant');
        });

        // æ£€æŸ¥åˆ°æœŸæé†’
        setInterval(() => {
            const today = new Date().toISOString().split('T')[0];
            const dueReminders = reminders.filter(r => r.followupDate === today);
            
            if (dueReminders.length > 0 && Notification.permission === 'granted') {
                dueReminders.forEach(reminder => {
                    new Notification('éšè®¿æé†’', {
                        body: `æ‚£è€… ${reminder.patientName} ä»Šæ—¥éœ€è¦éšè®¿ (${reminder.surgeryType})`,
                        icon: 'ğŸ«€'
                    });
                });
            }
        }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

        // è¯·æ±‚é€šçŸ¥æƒé™
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>